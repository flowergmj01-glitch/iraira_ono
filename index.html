<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è² é¢æƒ…ç·’æ“¬è²è©ï¼šã‚¤ãƒ©ã‚¤ãƒ© vs ãƒ¢ãƒ¤ãƒ¢ãƒ¤ (ä¸­æ—¥å°ç…§ç‰ˆ)</title>
    
    <!-- Fonts: Zen Maru Gothic (Cute/Rounded) & Kiwi Maru (Artistic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* --- Negative Emotions Palette --- */
            
            /* Background Gradient - Slightly moodier but still approachable */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            
            /* Theme Colors for Specific Slides */
            --theme-red: #ef5350;    /* Ira-ira (Anger) */
            --theme-purple: #9575cd; /* Moya-moya (Hazy) */
            --theme-green: #aed581;  /* Muka-muka (Sick/Angry) */
            --theme-blue: #64b5f6;   /* Gakkari (Disappointed) */
            --theme-grey: #90a4ae;   /* Shobon (Dejected) */

            /* UI Colors */
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-color: #37474f;
            --text-sub: #78909c;
            
            /* Fonts */
            --font-title: 'Kiwi Maru', serif;
            --font-body: 'Zen Maru Gothic', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #ece9e6; 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(239, 83, 80, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(100, 181, 246, 0.1) 0%, transparent 20%);
            font-family: var(--font-body);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Toolbar --- */
        .toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 2px solid #fff;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 20px;
            background: #fff;
            color: #555;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #btn-brush:hover, #btn-brush.active { background: #ffccbc; color: #d84315; }
        #btn-eraser:hover, #btn-eraser.active { background: #cfd8dc; color: #455a64; }
        #btn-text:hover, #btn-text.active { background: #b3e5fc; color: #0277bd; }
        #btn-move:hover, #btn-move.active { background: #dcedc8; color: #33691e; }
        #btn-print:hover, #btn-print.active { background: #e1bee7; color: #6a1b9a; }

        .tool-btn:hover { transform: scale(1.1) rotate(5deg); }
        .tool-btn:active { transform: scale(0.95); }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 5px;
            padding-top: 10px;
            border-top: 2px dashed #eee;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.2); }
        .color-swatch.active { transform: scale(1.2); border-color: #333; }

        /* --- Slide Container --- */
        #app-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 100px;
            position: relative;
        }

        .slide {
            width: 100%;
            max-width: 1100px;
            height: 100%;
            max-height: 90vh;
            aspect-ratio: 16/9;
            background: var(--card-bg);
            border-radius: 35px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            position: relative;
            display: none;
            overflow: hidden;
            flex-direction: column;
            border: 6px solid #fff;
        }

        .slide.active { display: flex; }

        /* Dynamic Theme Styles */
        /* Red - Ira-ira */
        .slide[data-theme="red"] { border-color: #ffcdd2; }
        .slide[data-theme="red"] .slide-title { color: var(--theme-red); }
        .slide[data-theme="red"] .situation-tag { background: var(--theme-red); }
        .slide[data-theme="red"] .col-right { background: linear-gradient(135deg, #ffebee, #fff); }

        /* Purple - Moya-moya */
        .slide[data-theme="purple"] { border-color: #d1c4e9; }
        .slide[data-theme="purple"] .slide-title { color: var(--theme-purple); }
        .slide[data-theme="purple"] .situation-tag { background: var(--theme-purple); }
        .slide[data-theme="purple"] .col-right { background: linear-gradient(135deg, #ede7f6, #fff); }

        /* Green - Muka-muka */
        .slide[data-theme="green"] { border-color: #dcedc8; }
        .slide[data-theme="green"] .slide-title { color: var(--theme-green); }
        .slide[data-theme="green"] .situation-tag { background: var(--theme-green); }
        .slide[data-theme="green"] .col-right { background: linear-gradient(135deg, #f1f8e9, #fff); }

        /* Blue - Gakkari */
        .slide[data-theme="blue"] { border-color: #bbdefb; }
        .slide[data-theme="blue"] .slide-title { color: var(--theme-blue); }
        .slide[data-theme="blue"] .situation-tag { background: var(--theme-blue); }
        .slide[data-theme="blue"] .col-right { background: linear-gradient(135deg, #e3f2fd, #fff); }

        /* Grey - Shobon */
        .slide[data-theme="grey"] { border-color: #cfd8dc; }
        .slide[data-theme="grey"] .slide-title { color: var(--theme-grey); }
        .slide[data-theme="grey"] .situation-tag { background: var(--theme-grey); }
        .slide[data-theme="grey"] .col-right { background: linear-gradient(135deg, #eceff1, #fff); }


        /* Layers */
        .drawing-layer, .text-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .drawing-layer { z-index: 10; cursor: crosshair; touch-action: none; }
        .text-layer { z-index: 11; pointer-events: none; }

        .user-text {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #444;
            padding: 5px 10px;
            border-radius: 10px;
            font-family: var(--font-body);
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
            pointer-events: auto;
            cursor: text;
        }
        .user-text.draggable { cursor: grab; background: #fff9c4; border-style: solid; }

        /* Content Layout */
        .slide-content {
            padding: 35px 50px;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        .slide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px dotted #ddd;
        }

        .slide-title {
            font-family: var(--font-title);
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.05);
        }

        .slide-number {
            font-family: var(--font-body);
            font-weight: 700;
            color: #fff;
            font-size: 1.1rem;
            background: #b0bec5;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .slide-body {
            flex: 1;
            display: flex;
            gap: 40px;
            overflow: hidden;
        }

        .col-left {
            flex: 1.1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 10px;
        }

        .col-right {
            flex: 0.9;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 30px;
            position: relative;
            border: 5px solid #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
        }

        /* Scrollbar */
        .col-left::-webkit-scrollbar { width: 8px; }
        .col-left::-webkit-scrollbar-track { background: transparent; }
        .col-left::-webkit-scrollbar-thumb { background-color: #cfd8dc; border-radius: 4px; }

        /* Elements */
        .big-word {
            font-family: var(--font-title);
            font-size: 3.5rem;
            color: #455a64;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .situation-tag {
            display: inline-block;
            color: white;
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 1rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .definition-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 15px;
            border-left: 6px solid #ccc;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }

        .def-jp { font-size: 1.2rem; margin-bottom: 5px; color: #37474f; }
        .def-tw { font-size: 1rem; color: #78909c; font-weight: normal; }

        /* Chat Box */
        .chat-container {
            background: #fafafa;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto;
            border: 2px solid #eee;
        }

        .chat-title {
            font-size: 0.9rem;
            color: #999;
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .chat-row { display: flex; align-items: flex-start; gap: 10px; }
        .chat-row.right { flex-direction: row-reverse; }

        .chat-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            border: 2px solid #eee;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 1.05rem;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-row.left .chat-bubble { background: #fff; color: #37474f; border-top-left-radius: 4px; }
        .chat-row.right .chat-bubble { background: #546e7a; color: #fff; border-top-right-radius: 4px; }

        /* Illustration */
        .illustration {
            font-size: 8rem;
            filter: drop-shadow(0 15px 0px rgba(0,0,0,0.1));
            animation: shake 4s infinite;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* Nav Buttons */
        .nav-btn {
            position: fixed; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.8);
            color: #555;
            width: 60px; height: 60px;
            border-radius: 50%; border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 1.5rem; cursor: pointer; z-index: 900;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .nav-btn:hover { transform: translateY(-50%) scale(1.1); background: #fff; color: var(--theme-red); }
        #prev-btn { left: 40px; }
        #next-btn { right: 40px; }

        @media print {
            .toolbar, .nav-btn { display: none !important; }
            #app-container { padding: 0; }
            .slide { display: flex !important; break-after: page; height: 100vh; border: none; box-shadow: none; }
            body { background: white; -webkit-print-color-adjust: exact; }
        }

        /* Grid for Quiz */
        .grid-cards {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;
        }
        .mini-card {
            padding: 20px; border-radius: 20px; text-align: left;
            transition: transform 0.2s; border: 2px solid transparent;
            background: #fff;
        }
        .mini-card:hover { transform: translateY(-5px); }
        
        .card-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
        .card-jp { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .card-tw { font-size: 0.9rem; opacity: 0.8; }

    </style>
</head>
<body>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn active" id="btn-brush" title="ç•«ç­† (Pen)"><i class="fas fa-pen"></i></button>
        <button class="tool-btn" id="btn-eraser" title="æ©¡çš®æ“¦ (Eraser)"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" id="btn-text" title="æ–‡å­— (Text)"><i class="fas fa-font"></i></button>
        <button class="tool-btn" id="btn-move" title="ç§»å‹• (Move)"><i class="fas fa-arrows-alt"></i></button>
        <button class="tool-btn" id="btn-print" title="åˆ—å° (Print)"><i class="fas fa-print"></i></button>
        
        <div class="color-palette" id="palette"></div>
    </div>

    <!-- Navigation -->
    <button class="nav-btn" id="prev-btn"><i class="fas fa-chevron-left"></i></button>
    <button class="nav-btn" id="next-btn"><i class="fas fa-chevron-right"></i></button>

    <!-- App Container -->
    <div id="app-container">
        
        <!-- Slide 1: Cover (Red Theme - Irritation) -->
        <div class="slide active" id="slide-1" data-theme="red">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content center-text" style="justify-content: center; text-align: center;">
                <div class="illustration" style="color: var(--theme-red); margin-bottom: 20px;">
                    <i class="fas fa-face-angry"></i>
                </div>
                <h1 style="font-family: var(--font-title); font-size: 3.5rem; color: #37474f; margin-bottom: 10px;">
                    ã‚¤ãƒ©ã‚¤ãƒ© vs ãƒ¢ãƒ¤ãƒ¢ãƒ¤<br>
                    <span style="font-size: 2rem; color: var(--theme-red);">è² é¢æƒ…ç·’æ€éº¼èªªï¼Ÿ</span>
                </h1>
                <h2 style="font-family: var(--font-body); font-size: 1.5rem; color: #78909c;">
                    æ—¥æœ¬èªã®ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆã‚ªãƒãƒãƒˆãƒš<br>
                    <span style="font-size: 1.2rem;">å®£æ´©å£“åŠ›çš„æ—¥æ–‡æ“¬è²è©</span>
                </h2>
                <div style="margin-top: 40px; font-size: 1.2rem; background: var(--theme-red); padding: 12px 40px; border-radius: 50px; color: white; font-weight: bold; box-shadow: 0 10px 20px rgba(239, 83, 80, 0.3);">
                    æƒ…æ„Ÿè¡¨é”æœƒè©± (æ„Ÿæƒ…è¡¨ç¾ãƒ¬ãƒƒã‚¹ãƒ³)
                </div>
            </div>
        </div>

        <!-- Slide 2: Scene (Theme: Feelings) -->
        <div class="slide" id="slide-2" data-theme="purple">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å ´é¢ï¼šã‚¹ãƒˆãƒ¬ã‚¹ç¤¾ä¼š <small style="font-size:0.6em; color:#888;">(å ´é¢ï¼šå£“åŠ›ç¤¾æœƒ)</small></h3>
                    <span class="slide-number">02 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <p style="font-size: 1.3rem; line-height: 1.8;">
                            æ—¥å¸¸ç”Ÿæ´»ã§ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã‚‹ã“ã¨ã¯ã‚ˆãã‚ã‚Šã¾ã™ã€‚<br>
                            <span style="color:#78909c; font-size: 1.1rem;">æ—¥å¸¸ç”Ÿæ´»ä¸­ç¶“å¸¸æœƒæ„Ÿå—åˆ°å£“åŠ›ã€‚</span><br><br>
                            ãã‚“ãªã€Œè² ã®æ„Ÿæƒ…ã€ã‚’æ—¥æœ¬èªã§ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã€è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br>
                            <span style="color:#78909c; font-size: 1.1rem;">è®“æˆ‘å€‘ä¾†çœ‹çœ‹å¦‚ä½•ç”¨æ—¥æ–‡è¡¨é”é€™äº›ã€Œè² é¢æƒ…ç·’ã€ã€‚</span>
                        </p>
                        
                        <h4 style="color: var(--theme-purple); margin-top: 20px; font-size: 1.3rem;">ä»Šæ—¥çš„å­¸ç¿’é‡é» (ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆ)ï¼š</h4>
                        <ul style="font-size: 1.2rem; list-style: none; padding: 0; line-height: 2;">
                            <li style="background:#ffebee; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#c62828;">
                                <i class="fas fa-fire"></i> <strong>ã‚¤ãƒ©ã‚¤ãƒ©</strong> (Ira-ira) - ç…©èº/ç„¦æ…®
                            </li>
                            <li style="background:#ede7f6; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#4527a0;">
                                <i class="fas fa-smog"></i> <strong>ãƒ¢ãƒ¤ãƒ¢ãƒ¤</strong> (Moya-moya) - é¬±æ‚¶/ç³¾çµ
                            </li>
                            <li style="background:#f1f8e9; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#33691e;">
                                <i class="fas fa-face-dizzy"></i> <strong>ãƒ ã‚«ãƒ ã‚«</strong> (Muka-muka) - å™å¿ƒ/ç”Ÿæ°£
                            </li>
                        </ul>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-cloud-rain illustration" style="color: var(--theme-purple);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 3: Ira-ira (Red Theme) -->
        <div class="slide" id="slide-3" data-theme="red">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ç„¦ã‚Šãƒ»ä¸æº€ <small style="font-size:0.6em; color:#888;">(ç„¦èºãƒ»ä¸æ»¿)</small></h3>
                    <span class="slide-number">03 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-red);">ã‚¤ãƒ©ã‚¤ãƒ©</div>
                        <div class="situation-tag">å ´é¢ï¼šæ—¢èª­ã‚¹ãƒ«ãƒ¼ã€æ¸‹æ»ã€å¾…ã¡æ™‚é–“ (å·²è®€ä¸å›ã€å¡è»Šã€ç­‰å¾…æ™‚)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-red);">
                            <div class="def-jp">æ€ã„é€šã‚Šã«ãªã‚‰ãªãã¦ã€ç¥çµŒãŒé«˜ã¶ã‚‹æ§˜å­ã€‚æ€’ã‚Šã‚’æˆ‘æ…¢ã—ã¦ã„ã‚‹çŠ¶æ…‹ã€‚</div>
                            <div class="def-tw">å› ç‚ºäº‹æƒ…ä¸é †å¿ƒè€Œç¥ç¶“ç·Šç¹ƒã€ç…©èºçš„æ¨£å­ã€‚å¿è€è‘—æ€’æ°£çš„ç‹€æ…‹ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-red);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    ã¾ã å½¼ã‹ã‚‰è¿”ä¿¡æ¥ãªã„ã®ï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#888;">ä»–é‚„æ²’å›è¨Šæ¯å—ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-red);">
                                    ã†ã‚“ã€æ—¢èª­ã«ãªã£ã¦ã‚‹ã®ã«ï¼ã‚‚ã†<strong>ã‚¤ãƒ©ã‚¤ãƒ©</strong>ã™ã‚‹ï¼<br>
                                    <span style="font-size:0.8em; opacity:0.8;">å—¯ï¼Œæ˜æ˜å·²è®€äº†ï¼çœŸè®“äººç…©èº(Ira-ira)ï¼</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-red);"><i class="fas fa-face-angry"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-bolt illustration" style="color: var(--theme-red);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 4: Moya-moya (Purple Theme) -->
        <div class="slide" id="slide-4" data-theme="purple">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ã‚¹ãƒƒã‚­ãƒªã—ãªã„ <small style="font-size:0.6em; color:#888;">(ä¸èˆ’æš¢)</small></h3>
                    <span class="slide-number">04 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-purple);">ãƒ¢ãƒ¤ãƒ¢ãƒ¤</div>
                        <div class="situation-tag">å ´é¢ï¼šæ‚©ã¿äº‹ãŒã‚ã‚‹æ™‚ã€ç´å¾—ã§ããªã„æ™‚ (æœ‰ç…©æƒ±ã€ç„¡æ³•æ¥å—æ™‚)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-purple);">
                            <div class="def-jp">å¿ƒã®ä¸­ã«ã‚ã ã‹ã¾ã‚ŠãŒã‚ã£ã¦ã€æ™´ã‚Œãªã„æ§˜å­ã€‚å¿ƒé…äº‹ãŒã‚ã‚‹æ™‚ã«ã‚ˆãä½¿ã„ã¾ã™ã€‚</div>
                            <div class="def-tw">å¿ƒè£¡æœ‰ç–™ç˜©ï¼Œå¿ƒæƒ…ä¸æ™´æœ—çš„æ¨£å­ã€‚å¸¸ç”¨æ–¼æœ‰æ“”å¿ƒçš„äº‹æƒ…æˆ–ç„¡æ³•é‡‹æ‡·æ™‚ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-purple);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    å–§å˜©ã®ã‚ã¨ã€ä»²ç›´ã‚Šã—ãŸã‚“ã§ã—ã‚‡ï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#888;">åµæ¶ä¹‹å¾Œï¼Œä¸æ˜¯å’Œå¥½äº†å—ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-purple);">
                                    ä¸€å¿œã­ã€‚ã§ã‚‚ãªã‚“ã‹ã¾ã <strong>ãƒ¢ãƒ¤ãƒ¢ãƒ¤</strong>ã—ã¦ã‚‹ã‚“ã ã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.8;">ç®—æ˜¯å§ã€‚ä½†å¿ƒè£¡ç¸½è¦ºå¾—é‚„æœ‰é»ç–™ç˜©(Moya-moya)ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-purple);"><i class="fas fa-cloud"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-smog illustration" style="color: var(--theme-purple);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 5: Muka-muka (Green Theme) -->
        <div class="slide" id="slide-5" data-theme="green">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">åãæ°—ãƒ»æ€’ã‚Š <small style="font-size:0.6em; color:#888;">(æƒ³åãƒ»æ†¤æ€’)</small></h3>
                    <span class="slide-number">05 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-green);">ãƒ ã‚«ãƒ ã‚«</div>
                        <div class="situation-tag">å ´é¢ï¼šäºŒæ—¥é…”ã„ã€æ‚ªå£ã‚’èã„ãŸæ™‚ (å®¿é†‰ã€è½åˆ°å£è©±æ™‚)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-green);">
                            <div class="def-jp">â‘  èƒƒãŒæ°—æŒã¡æ‚ªã„ã“ã¨ï¼ˆåãæ°—ï¼‰ã€‚<br>â‘¡ è…¹ãŒç«‹ã£ã¦æ°—åˆ†ãŒæ‚ªã„ã“ã¨ã€‚</div>
                            <div class="def-tw">â‘  èƒƒä¸èˆ’æœï¼ˆæƒ³åï¼‰ã€‚<br>â‘¡ å› ç‚ºç”Ÿæ°£è€Œæ„Ÿåˆ°ä¸å¿«ï¼ˆç«å¤§ï¼‰ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-green);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    æ˜¨æ—¥ã®é£²ã¿ä¼šã€å¤§ä¸ˆå¤«ã ã£ãŸï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#888;">æ˜¨å¤©çš„èšé¤é‚„å¥½å—ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-green);">
                                    é£²ã¿ã™ãã¦èƒƒãŒ<strong>ãƒ ã‚«ãƒ ã‚«</strong>ã™ã‚‹...<br>
                                    <span style="font-size:0.8em; opacity:0.8;">å–å¤ªå¤šäº†ï¼Œç¾åœ¨èƒƒå¾ˆä¸èˆ’æœ(Muka-muka)ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-green);"><i class="fas fa-face-dizzy"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-virus illustration" style="color: var(--theme-green);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 6: Gakkari (Blue Theme) -->
        <div class="slide" id="slide-6" data-theme="blue">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å¤±æœ›ãƒ»è½èƒ† <small style="font-size:0.6em; color:#888;">(å¤±æœ›ãƒ»ç°å¿ƒ)</small></h3>
                    <span class="slide-number">06 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-blue);">ã‚¬ãƒƒã‚«ãƒª</div>
                        <div class="situation-tag">å ´é¢ï¼šæœŸå¾…å¤–ã‚Œã€ãƒ†ã‚¹ãƒˆãŒæ‚ªã‹ã£ãŸæ™‚ (æœŸå¾…è½ç©ºã€è€ƒä¸å¥½æ™‚)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-blue);">
                            <div class="def-jp">æœŸå¾…ã—ã¦ã„ãŸã“ã¨ãŒãƒ€ãƒ¡ã«ãªã£ã¦ã€åŠ›ãŒæŠœã‘ã‚‹æ§˜å­ã€‚å¤±æœ›ã™ã‚‹ã“ã¨ã€‚</div>
                            <div class="def-tw">æœŸå¾…çš„äº‹æƒ…è½ç©ºï¼Œæ„Ÿåˆ°æ¸¾èº«ç„¡åŠ›ã€‚è¡¨ç¤ºå¤±æœ›ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-blue);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    ã‚ã®æ˜ ç”»ã€ã©ã†ã ã£ãŸï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#888;">é‚£éƒ¨é›»å½±æ€éº¼æ¨£ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-blue);">
                                    ã†ãƒ¼ã‚“ã€æœŸå¾…ã—ã¦ãŸã®ã«<strong>ã‚¬ãƒƒã‚«ãƒª</strong>ã ã£ãŸã‚ˆã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.8;">å—¯...æ˜æ˜å¾ˆæœŸå¾…ï¼Œçµæœå¥½å¤±æœ›(Gakkari)å–”ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-blue);"><i class="fas fa-face-frown"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-cloud-showers-heavy illustration" style="color: var(--theme-blue);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 7: Shobon (Grey Theme) -->
        <div class="slide" id="slide-7" data-theme="grey">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å…ƒæ°—ãŒãªã„ <small style="font-size:0.6em; color:#888;">(ç„¡ç²¾æ‰“é‡‡)</small></h3>
                    <span class="slide-number">07 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-grey);">ã‚·ãƒ§ãƒœãƒ¼ãƒ³</div>
                        <div class="situation-tag">å ´é¢ï¼šå¤±æ•—ã—ãŸæ™‚ã€æ€’ã‚‰ã‚ŒãŸå¾Œ (å¤±æ•—æ™‚ã€è¢«ç½µä¹‹å¾Œ)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-grey);">
                            <div class="def-jp">å…ƒæ°—ãŒãªããªã£ã¦ã€ã—ãŠã‚Œã¦ã„ã‚‹æ§˜å­ã€‚é¡”æ–‡å­— (Â´ãƒ»Ï‰ãƒ»ï½€) ã‹ã‚‰ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚</div>
                            <div class="def-tw">è®Šå¾—æ²’æœ‰ç²¾ç¥ã€å‚é ­å–ªæ°£çš„æ¨£å­ã€‚å¸¸ç”¨æ–¼é¡æ–‡å­— (Â´ãƒ»Ï‰ãƒ»ï½€)ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-grey);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    ç”°ä¸­ãã‚“ã€ã©ã†ã—ãŸã®ï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#888;">ç”°ä¸­åŒå­¸æ€éº¼äº†ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-grey);">
                                    å…ˆç”Ÿã«æ€’ã‚‰ã‚Œã¦<strong>ã‚·ãƒ§ãƒœãƒ¼ãƒ³</strong>ã¨ã—ã¦ã‚‹ã‚“ã ã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.8;">è¢«è€å¸«ç½µäº†ï¼Œæ­£åœ¨å‚é ­å–ªæ°£(Shobon)å‘¢ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-grey);"><i class="fas fa-face-sad-tear"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <div style="text-align: center;">
                            <span style="font-size: 6rem; color: var(--theme-grey);"> (Â´ãƒ»Ï‰ãƒ»ï½€) </span>
                            <br><br>
                            <i class="fas fa-arrow-down illustration" style="color: var(--theme-grey);"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 8: Review Quiz (Red Theme) -->
        <div class="slide" id="slide-8" data-theme="red">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ç·´ç¿’å•é¡Œ <small style="font-size:0.6em; color:#888;">(ç·´ç¿’é¡Œ)</small></h3>
                    <span class="slide-number">08 / 10</span>
                </div>
                <div class="slide-body" style="flex-direction: column;">
                    <p style="text-align: center; color: #555; font-size: 1.2rem;">
                        æ­£ã—ã„è¨€è‘‰ã‚’é¸ã‚“ã§æ›¸ãã¾ã—ã‚‡ã†ï¼<br>
                        <span style="font-size:1rem; color:#888;">è«‹é¸å‡ºæ­£ç¢ºçš„è©å½™ä¸¦å¯«ä¸‹ä¾†ï¼</span>
                    </p>
                    
                    <div class="grid-cards">
                        <!-- Card 1 -->
                        <div class="mini-card" style="background:#ffebee; border-color:#ef9a9a;">
                            <span class="card-icon" style="color:#c62828;"><i class="fas fa-bolt"></i></span>
                            <span class="card-jp">æ—¢èª­ã‚¹ãƒ«ãƒ¼ã§æ€’ã‚‹</span>
                            <span class="card-tw">å·²è®€ä¸å›å¾ˆç”Ÿæ°£</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#b71c1c;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 2 -->
                        <div class="mini-card" style="background:#ede7f6; border-color:#b39ddb;">
                            <span class="card-icon" style="color:#4527a0;"><i class="fas fa-smog"></i></span>
                            <span class="card-jp">å¿ƒé…äº‹ã§ã¯ã£ãã‚Šã—ãªã„</span>
                            <span class="card-tw">æ“”å¿ƒäº‹æƒ…ä¸æ˜æœ—</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#311b92;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 3 -->
                        <div class="mini-card" style="background:#e3f2fd; border-color:#90caf9;">
                            <span class="card-icon" style="color:#1565c0;"><i class="fas fa-cloud-showers-heavy"></i></span>
                            <span class="card-jp">æœŸå¾…å¤–ã‚Œã§æ®‹å¿µ</span>
                            <span class="card-tw">æœŸå¾…è½ç©ºå¾ˆéºæ†¾</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#0d47a1;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 4 -->
                        <div class="mini-card" style="background:#f1f8e9; border-color:#a5d6a7;">
                            <span class="card-icon" style="color:#33691e;"><i class="fas fa-face-dizzy"></i></span>
                            <span class="card-jp">èƒƒãŒæ°—æŒã¡æ‚ªã„</span>
                            <span class="card-tw">èƒƒä¸èˆ’æœ/æƒ³å</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#1b5e20;">ã€Œ_______ã€</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; color: #757575;">
                        é¸æ“‡ï¼šãƒ ã‚«ãƒ ã‚«ã€ã‚¤ãƒ©ã‚¤ãƒ©ã€ã‚¬ãƒƒã‚«ãƒªã€ãƒ¢ãƒ¤ãƒ¢ãƒ¤
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 9: Conclusion (Green Theme - Relief) -->
        <div class="slide" id="slide-9" data-theme="green">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content center-text" style="justify-content: center; text-align: center;">
                <div style="font-size: 6rem; color: var(--theme-green); margin-bottom: 20px;">
                    <i class="fas fa-leaf"></i>
                </div>
                <h2 style="font-family: var(--font-title); font-size: 3rem; color: #333; margin-bottom: 5px;">
                    ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸã‹ï¼Ÿ
                </h2>
                <h3 style="font-size: 1.5rem; color: #757575; font-weight: normal; margin-bottom: 30px;">
                    (æ„Ÿè¦ºèˆ’æš¢äº†å—ï¼Ÿ)
                </h3>
                
                <div style="width: 85%; text-align: left; background: #fff; padding: 30px; border-radius: 20px; border: 2px dashed #aed581; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                    <h3 style="color: var(--theme-green); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;">ç¸½çµ (ã¾ã¨ã‚)ï¼š</h3>
                    <ul style="font-size: 1.2rem; line-height: 2.2; list-style: none; padding-left: 0;">
                        <li><span style="color:#ef5350;">ğŸ’¢ <strong>ã‚¤ãƒ©ã‚¤ãƒ©</strong></span>ï¼šç„¦èº (Irritated)</li>
                        <li><span style="color:#9575cd;">â˜ï¸ <strong>ãƒ¢ãƒ¤ãƒ¢ãƒ¤</strong></span>ï¼šé¬±æ‚¶ (Hazy/Gloomy)</li>
                        <li><span style="color:#66bb6a;">ğŸ¤¢ <strong>ãƒ ã‚«ãƒ ã‚«</strong></span>ï¼šå™å¿ƒ/ç”Ÿæ°£ (Nauseous/Angry)</li>
                        <li><span style="color:#42a5f5;">ğŸ’§ <strong>ã‚¬ãƒƒã‚«ãƒª</strong></span>ï¼šå¤±æœ› (Disappointed)</li>
                        <li><span style="color:#78909c;">â¤µï¸ <strong>ã‚·ãƒ§ãƒœãƒ¼ãƒ³</strong></span>ï¼šå‚é ­å–ªæ°£ (Dejected)</li>
                    </ul>
                </div>
                <p style="margin-top: 30px; font-weight: bold; font-size: 1.3rem; color: var(--theme-green);">
                    è¨€è‘‰ã«ã™ã‚‹ã¨ã€ã‚¹ãƒˆãƒ¬ã‚¹ãŒå°‘ã—æ¸›ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã‚ˆï¼<br>
                    <span style="font-size: 1rem; color: #757575; font-weight: normal;">è©¦è‘—èªªå‡ºä¾†ï¼Œå£“åŠ›æˆ–è¨±æœƒæ¸›å°‘ä¸€äº›å–”ï¼</span>
                </p>
            </div>
        </div>

    </div>

    <script>
        // --- State Management ---
        const state = {
            currentSlide: 1,
            totalSlides: 9, // Updated count
            tool: 'brush', 
            color: '#333333',
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            brushSize: 4
        };

        // --- Elements ---
        const slides = document.querySelectorAll('.slide');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const palette = document.getElementById('palette');

        // --- Colors Palette (Matched to Themes) ---
        const colors = [
            '#333333', '#ef5350', // Black, Red
            '#9575cd', '#aed581', // Purple, Green
            '#64b5f6', '#90a4ae', // Blue, Grey
            '#ffb74d', '#f06292', // Orange, Pink
            '#4db6ac', '#795548'  // Teal, Brown
        ];

        function init() {
            setupNavigation();
            setupPalette();
            setupTools();
            setupCanvasForSlide(1);
            setupTextLayer(1);
            updateSlideVisibility();
            
            window.addEventListener('resize', () => resizeCanvas(state.currentSlide));
        }

        // --- Navigation ---
        function setupNavigation() {
            prevBtn.addEventListener('click', () => changeSlide(-1));
            nextBtn.addEventListener('click', () => changeSlide(1));
            
            document.getElementById('btn-print').addEventListener('click', () => {
                slides.forEach((slide, index) => resizeCanvas(index + 1));
                window.print();
            });
        }

        function changeSlide(direction) {
            const next = state.currentSlide + direction;
            if (next >= 1 && next <= state.totalSlides) {
                state.currentSlide = next;
                updateSlideVisibility();
                setupCanvasForSlide(next);
                setupTextLayer(next);
            }
        }

        function updateSlideVisibility() {
            slides.forEach((slide, index) => {
                slide.classList.toggle('active', index + 1 === state.currentSlide);
            });
            prevBtn.style.opacity = state.currentSlide === 1 ? '0.5' : '1';
            prevBtn.style.pointerEvents = state.currentSlide === 1 ? 'none' : 'auto';
            nextBtn.style.opacity = state.currentSlide === state.totalSlides ? '0.5' : '1';
            nextBtn.style.pointerEvents = state.currentSlide === state.totalSlides ? 'none' : 'auto';
        }

        // --- Palette & Tools ---
        function setupPalette() {
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => setColor(color, swatch));
                palette.appendChild(swatch);
            });
            // Set default active color (black)
            palette.children[0].classList.add('active');
            state.color = colors[0];
        }

        function setColor(color, element) {
            state.color = color;
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            if (state.tool === 'eraser') setTool('brush');
        }

        function setupTools() {
            const tools = {
                'btn-brush': 'brush',
                'btn-eraser': 'eraser',
                'btn-text': 'text',
                'btn-move': 'move'
            };
            for (const [id, toolName] of Object.entries(tools)) {
                document.getElementById(id).addEventListener('click', () => setTool(toolName));
            }
        }

        function setTool(toolName) {
            state.tool = toolName;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${toolName}`).classList.add('active');
            updateLayerInteractions();
        }

        function updateLayerInteractions() {
            const activeSlide = document.getElementById(`slide-${state.currentSlide}`);
            const canvas = activeSlide.querySelector('.drawing-layer');
            const textLayer = activeSlide.querySelector('.text-layer');

            if (state.tool === 'brush' || state.tool === 'eraser') {
                canvas.style.pointerEvents = 'auto';
                textLayer.style.pointerEvents = 'none';
                canvas.style.cursor = 'crosshair';
            } else if (state.tool === 'text') {
                canvas.style.pointerEvents = 'none';
                textLayer.style.pointerEvents = 'auto';
                textLayer.style.cursor = 'text';
            } else if (state.tool === 'move') {
                canvas.style.pointerEvents = 'none';
                textLayer.style.pointerEvents = 'auto';
                textLayer.style.cursor = 'default';
            }
        }

        // --- Canvas Drawing ---
        function setupCanvasForSlide(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const canvas = slide.querySelector('.drawing-layer');
            if (canvas.width !== slide.clientWidth) resizeCanvas(slideIndex);
            
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!canvas.dataset.listenersAdded) {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.dataset.listenersAdded = 'true';
            }
        }

        function resizeCanvas(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const canvas = slide.querySelector('.drawing-layer');
            const ctx = canvas.getContext('2d');

            let tempCanvas;
            if (canvas.width > 0 && canvas.height > 0) {
                 tempCanvas = document.createElement('canvas');
                 tempCanvas.width = canvas.width;
                 tempCanvas.height = canvas.height;
                 tempCanvas.getContext('2d').drawImage(canvas, 0, 0);
            }

            canvas.width = slide.clientWidth;
            canvas.height = slide.clientHeight;

            if (tempCanvas) {
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            }
        }

        function startDrawing(e) {
            if (state.tool !== 'brush' && state.tool !== 'eraser') return;
            state.isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            state.lastX = e.clientX - rect.left;
            state.lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!state.isDrawing) return;
            const ctx = e.target.getContext('2d');
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineWidth = state.tool === 'eraser' ? 20 : state.brushSize;
            ctx.strokeStyle = state.tool === 'eraser' ? 'rgba(0,0,0,1)' : state.color;
            ctx.globalCompositeOperation = state.tool === 'eraser' ? 'destination-out' : 'source-over';

            ctx.beginPath();
            ctx.moveTo(state.lastX, state.lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            state.lastX = x;
            state.lastY = y;
        }

        function stopDrawing() { state.isDrawing = false; }

        // --- Text Tool ---
        function setupTextLayer(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const textLayer = slide.querySelector('.text-layer');
            if (!textLayer.dataset.listenersAdded) {
                textLayer.addEventListener('click', (e) => {
                    if (state.tool === 'text' && e.target === textLayer) {
                        createTextField(e.offsetX, e.offsetY, textLayer);
                    }
                });
                textLayer.dataset.listenersAdded = 'true';
            }
        }

        function createTextField(x, y, container) {
            const div = document.createElement('div');
            div.className = 'user-text';
            div.contentEditable = true;
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            div.style.color = state.color;
            div.innerHTML = ''; 
            
            div.addEventListener('mousedown', (e) => {
                if (state.tool === 'move') {
                    e.preventDefault(); 
                    initDrag(e, div);
                } else {
                    e.stopPropagation();
                }
            });

            container.appendChild(div);
            setTimeout(() => div.focus(), 0);
            div.addEventListener('blur', () => {
                if(div.innerText.trim() === '') div.remove();
            });
        }

        function initDrag(e, el) {
            el.classList.add('draggable');
            const startX = e.clientX;
            const startY = e.clientY;
            const rect = el.getBoundingClientRect();
            const parentRect = el.parentElement.getBoundingClientRect();
            const offsetX = startX - rect.left;
            const offsetY = startY - rect.top;

            function onMouseMove(moveEvent) {
                const newX = moveEvent.clientX - parentRect.left - offsetX;
                const newY = moveEvent.clientY - parentRect.top - offsetY;
                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
            }

            function onMouseUp() {
                el.classList.remove('draggable');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        init();
    </script>
</body>
</html>